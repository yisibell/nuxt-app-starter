include app-snippets/query.currency.map;
include app-snippets/country-currency.default.map;
include app-snippets/map.common;
include app-snippets/urlparser;

split_clients "${time_local}_${hostname}_${http_cf_ipcountry}_${http_cloudfront_is_mobile_viewer}" $mine_abtesting_version {
            49%   A;
            49%   B;
             *    C;
}

server {
    listen 80;
    listen 443 ssl;

    ssl_certificate /etc/nginx/ssl/veryvoga.com.crt;
    ssl_certificate_key /etc/nginx/ssl/veryvoga.com.key;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;

    server_name ~^(?<subhost>[-\w]+)\.(?<domainname>[-\w]+)\.(?<subsite>.+)$;
    set $site_name $domainname.$subsite;
    set $pc_site_name www.$domainname.$subsite;
    set $subdomain '';
    set $mine_cookie_domain .$domainname.$subsite;
    set $prjroot /var/www/http/luban;
    include app-snippets/as.domain;
    include app-snippets/as.devices;

    access_log  logs/access-as-prod-www.log json_format;

    #set $currCid "0";
    if ( $cookie_JJCID ) {
        set $currCid $cookie_JJCID;
    }

    #set $currUCid "0";
    if ( $cookie_UCID ) {
        set $currUCid $cookie_UCID;
    }

    set $new_args '';
    if ($rewrite_uri != "") {
       rewrite .* $rewrite_uri?$new_args? last;
    }

    set $cf_ipcountry "null";
    if ($http_cf_ipcountry != "") {
        set $cf_ipcountry $http_cf_ipcountry;
    }

    if ($host !~* ^((p|www|uk|fr|de|pl|gr|se|au|ca|no|ch|mx|es|nl|it|cz|hu|ro|dk|us|at|be|fi|ie|nz|pt|tr|br|r3|r4|r2|r1)\..*)$) {
 #       rewrite ^/version$   /version break;
 #       rewrite ^/stack$   /stack break;
 #       rewrite ^/hotfixes$   /hotfixes break;
        rewrite ^/(.*)$ http://$pc_site_name/$1 permanent;
    }
    location = /version {
       include app-snippets/luban-prod.ims;
       default_type text/html ;
       return 200 $version;
    }
    location = /stack {
       include app-snippets/luban-prod.ims;    
       default_type text/html ;
       return 200 $stack;
    }
    location ~* /changecc.php {
        include app-snippets/add_header;
        proxy_pass              http://luban-api-prod;
        proxy_hide_header       Set-Cookie;
        proxy_redirect          off;
        proxy_set_header        Host            $host;
        proxy_set_header        X-Port          $server_port;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-ABTesting-Version $mine_abtesting_version;
        proxy_ignore_client_abort on;
        proxy_next_upstream http_502 http_504 http_500 error timeout invalid_header;
    }

    location ~* /internal_api/v1/flush_cache.php {
        include app-snippets/add_header;
        proxy_pass              http://luban-api-prod;
        proxy_hide_header       Set-Cookie;
        proxy_redirect          off;
        proxy_set_header        Host            $host;
        proxy_set_header        X-Port          $server_port;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-ABTesting-Version $mine_abtesting_version;
        proxy_ignore_client_abort on;
        proxy_next_upstream http_502 http_504 http_500 error timeout invalid_header;
    }

    location ~* {
        include app-snippets/state;
        include app-snippets/add_header;
        include app-snippets/luban-prod.ims;

        add_header cache $upstream_cache_status;

        if ($request_uri ~* (change-password|/my-address|/checkout|/compiler|/order|/orders|/coupon-center|/account|/ticket|/tickets|/wishlist|/setting|/cart)) {
            set $cache_disabled 1;
        }
        if ($cookie_preview = "true") {
            set $cache_disabled 1;
        }

        proxy_pass http://luban-nuster-prod:8080;
        # proxy_pass http://luban-prod:4008;
        proxy_redirect          off;
        proxy_set_header        Host $host;
        proxy_set_header        X-Port          $server_port;
        proxy_set_header        X-Real-IP       $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        abTestVersion $mine_abtesting_version;
        proxy_set_header        countryId $currUCid;
        proxy_set_header        currencyId $currCid;
        proxy_set_header        preview $cookie_preview;
        proxy_set_header        subdomain $subdomain;
        proxy_set_header        isArgs $is_args;
        proxy_set_header        cacheArgs $cache_args;
        proxy_set_header        cacheDisabled $cache_disabled;
        proxy_set_header        cacheKey $scheme://$host-$currCid-$currUCid-$cookie_abTest-$uri-$subdomain-$is_args$cache_args-$gotom-$cf_ipcountry-$version;

        proxy_ignore_client_abort on;
        proxy_next_upstream http_502 http_504 error timeout invalid_header;
        set $no_cache "1"; # 使用nuster时，强制性禁用nginx自身的文件缓存
        proxy_no_cache $no_cache;
        proxy_cache_bypass $no_cache;
        # proxy_no_cache $cookie_preview $cache_disabled;
        # proxy_cache_bypass $cookie_preview $cache_disabled;
        
        proxy_cache off;
        # proxy_cache cache_one;
        proxy_cache_valid  200 304 3h;
        proxy_cache_valid  301 302 1h;

        proxy_cache_key    $scheme://$host-$currCid-$currUCid-$cookie_abTest-$uri-$subdomain-$is_args$cache_args-$gotom-$cf_ipcountry;
        proxy_ignore_headers "Cache-Control" "Expires" "Set-Cookie";
        proxy_store off;
        proxy_hide_header  Set-Cookie;
   }

    include app-snippets/shared;
    include app-snippets/as.mobile;
    include app-snippets/g11n.2;
    include app-snippets/errpage.2;
#    include app-snippets/security;
    set $cache_disabled 0;
    set $abtesting_disabled 0;
}
